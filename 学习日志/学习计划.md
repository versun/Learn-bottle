# Bottle 源码学习教案

你好！作为你的 Python 老师，我为你准备了这份 Bottle 源码学习教案。我们将一起通过阅读源码和动手实践，深入理解这个轻量级 Web 框架的魅力。Bottle 的精髓在于其单文件实现，这为我们提供了绝佳的学习机会。

---

### 第一课：核心流程 - 从请求到响应

**1. 学习目标:**
*   理解 Bottle 应用的完整生命周期：接收 HTTP 请求 -> 路由匹配 -> 执行处理函数 -> 返回 HTTP 响应。
*   掌握最核心的 API：`@route()`, `run()`, `request`, `response`。

**2. 核心问题:**
*   `@route('/hello')` 是如何将一个 URL 和一个 Python 函数关联起来的？
*   `run(host='localhost', port=8080)` 是如何启动一个 Web 服务器的？
*   为什么我们可以在任何地方直接导入和使用 `request` 和 `response` 对象，而它们又能正确地处理并发请求？（提示：线程隔离）

**3. 源码导读 (`bottle.py`):**
*   `Bottle.route()`: 查看它如何创建一个 `Router` 对象，并将路径和函数注册进去。
*   `Router` 类: 重点关注 `add()` 和 `match()` 方法，理解路由规则是如何被解析和匹配的。
*   `Request` 和 `Response` 类: 阅读它们的属性和方法。特别注意 `LocalRequest` 和 `LocalResponse`，理解它们是如何利用 `threading.local` 实现线程安全的。
*   `run()` 函数: 了解它如何加载 `ServerAdapter` 并启动一个 WSGI 服务器。

**4. 动手实践:**
*   创建一个 `lesson1.py` 文件。
*   编写一个 `/` 路由，返回 "Hello, World!"。
*   编写一个 `/user/<name>` 动态路由，返回 "Hello, {name}!"。
*   编写一个 `/query` 路由，获取 URL 中的查询参数（如 `?id=123`），并将其返回。
*   在响应中设置一个自定义的 Header，例如 `X-Custom-Header: MyValue`。

---

### 第二课：模板渲染 - 让页面动起来

**1. 学习目标:**
*   掌握在 Bottle 中如何使用模板分离业务逻辑和表现层。
*   理解 Bottle 内置模板引擎 `SimpleTemplate` 的工作原理。

**2. 核心问题:**
*   `template('my_template', name='World')` 函数是如何找到 `my_template.tpl` 文件并用数据渲染它的？
*   `@view('my_template')` 装饰器是如何简化模板渲染流程的？
*   `SimpleTemplate` 是如何解析 `{{...}}` 和 `% ...` 语法的？

**3. 源码导读 (`bottle.py`):**
*   `template()` 和 `view()`: 这两个是高层 API，分析它们如何查找模板文件、管理模板路径和调用模板引擎。
*   `SimpleTemplate` 类: 这是 Bottle 的心脏之一。重点阅读它的 `__init__` 和 `render` 方法，看它是如何将模板代码转换成 Python 代码并执行的。

**4. 动手实践:**
*   创建一个 `lesson2.py` 和一个 `views` 文件夹。
*   在 `views` 中创建一个 `profile.tpl` 模板。
*   模板中需要展示一个用户的列表，使用循环 (`%for`) 来遍历。
*   如果用户列表为空，则显示一条提示信息，使用条件判断 (`%if ... %end`)。
*   在 `lesson2.py` 中创建一个 `/profile` 路由，将一个包含用户信息的 Python 列表传递给模板并渲染返回。

---

### 第三课：高级特性 - 插件、错误和静态文件

**1. 学习目标:**
*   学会使用静态文件路由 `static_file`。
*   掌握使用 `@error()` 装饰器处理不同 HTTP 错误的方法。
*   理解插件机制，并能编写一个简单的插件。

**2. 核心问题:**
*   `static_file()` 是如何安全地提供文件服务的？（如何防止路径遍历攻击？）
*   当路由未找到或代码抛出 `HTTPError` 时，Bottle 的内部处理流程是怎样的？
*   插件的生命周期是怎样的？`setup`, `apply`, `close` 这三个方法分别在什么时候被调用？

**3. 源码导读 (`bottle.py`):**
*   `static_file()`: 阅读源码，特别是关于路径安全处理的部分。
*   `Bottle.error()`: 查看它如何注册一个错误处理函数。
*   `Bottle._handle()`: 这是核心分发方法，观察它如何捕获异常并调用错误处理函数。
*   `Bottle.install()` 和 `Plugin` API: 理解插件是如何被安装和应用的。看 `apply` 方法是如何包装路由回调函数的。

**4. 动手实践:**
*   创建一个 `lesson3.py`。
*   创建一个 `/static/<filepath>` 路由来提供 `static` 目录下的 CSS 或 JS 文件。
*   为 404 Not Found 错误创建一个自定义的错误页面。
*   编写一个简单的插件，该插件在每个请求处理完成后，在响应头中加入处理耗时 `X-Request-Time`。

---

### 第四课：深入 WSGI - Bottle 的本质

**1. 学习目标:**
*   理解 WSGI (Web Server Gateway Interface) 的基本概念。
*   理解 Bottle 应用本身就是一个可调用的 WSGI application。
*   了解 `ServerAdapter` 如何将 Bottle 与不同的 Web 服务器集成。

**2. 核心问题:**
*   WSGI `environ` 和 `start_response` 是什么？
*   `Bottle.__call__` 方法是如何实现 WSGI 规范的？
*   为什么 `run()` 函数可以轻松切换不同的底层服务器（如 `wsgiref`, `cherrypy`）？

**3. 源码导读 (`bottle.py`):**
*   `Bottle.__call__()`: 这是整个框架最核心的入口。仔细阅读它，你会看到路由匹配、请求响应对象的创建、插件的应用等所有流程是如何串联起来的。
*   `ServerAdapter` 基类及其子类: 理解这个适配器模式是如何解耦 Bottle 框架和具体的 Web 服务器实现的。

**4. 动手实践:**
*   创建一个 `lesson4.py`。
*   不使用 `run()` 函数，而是直接使用 Python 内置的 `wsgiref` 库来启动你的 Bottle 应用，以加深对 WSGI 的理解。
*   尝试将 `run()` 函数的 `server` 参数改为 `'paste'` 或其他已安装的服务器，观察其变化。

---

### 第五课：毕业项目 - 构建并扩展

**1. 学习目标:**
*   综合运用所学知识，独立完成一个小型 Web 应用。
*   练习插件开发，为项目增加可复用的功能。

**2. 核心问题:**
*   如何组织一个稍复杂的 Bottle 项目的结构（例如，分离路由、模型和视图）？
*   如何设计一个插件来解决项目中的特定问题（如数据库连接、用户认证）？

**3. 源码导读 (`bottle.py`):**
*   回顾所有之前学习过的部分，将它们作为一个整体来理解。
*   思考 Bottle 的设计有哪些优点（简洁、无依赖、速度快）和缺点（功能相对基础）？

**4. 动手实践:**
*   **项目创意:** 一个简单的博客系统、一个在线笔记应用或一个 URL 短链接服务。
*   **功能要求:**
    *   至少包含 3 个不同的页面（路由）。
    *   使用模板进行页面渲染。
    *   提供静态文件服务（CSS/JS）。
    *   使用 SQLite 数据库进行数据持久化（可以开发一个 SQLite 插件来管理连接）。
    *   自定义错误页面。

---

准备好了吗？让我们从第一课开始吧！随时可以向我提问。
